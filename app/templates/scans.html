{% extends "base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Scans</h1>
<button class="btn" onclick="startScanModal.showModal()">Start Scan</button>
<dialog id="startScanModal" class="modal">
    <form method="dialog" class="modal-box">
        <h3 class="font-bold text-lg">Start New Scan</h3>
        <div class="form-control">
            <label class="label">
                <span class="label-text">Scan Name</span>
            </label>
            <input type="text" id="scan-name" class="input input-bordered" />
        </div>
        <div class="modal-action">
            <button type="button" class="btn" onclick="startScan()">Start</button>
        </div>
    </form>
</dialog>
<div class="flex gap-4 mt-4">
    <input type="text" id="name-filter" placeholder="Search by name" class="input input-bordered" />
    <select id="status-filter" class="select select-bordered">
        <option value="">All Statuses</option>
        <option value="running">Running</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
    </select>
    <button class="btn" onclick="refreshTable()">Filter</button>
    <button class="btn" onclick="refreshTable()">Refresh</button>
</div>
<div id="scans-table" class="mt-4">
    <table class="table w-full">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Timestamp</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for scan in scans %}
            <tr>
                <td>{{ scan.id }}</td>
                <td>{{ scan.name }}</td>
                <td>{{ scan.timestamp }}</td>
                <td>{{ scan.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
function refreshTable() {
    const name = $('#name-filter').val();
    const status = $('#status-filter').val();
    $.get('/scans/table', { name: name, status: status }, function(data) {
        $('#scans-table').html(data);
    });
}

function startScan() {
    const scanName = $('#scan-name').val();
    if (!scanName) {
        toastr.error('Please enter a scan name');
        return;
    }
    $.ajax({
        url: '/scans',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ name: scanName }),
        success: function(response) {
            toastr.success(response.message);
            $('#startScanModal').close();
            refreshTable();
        },
        error: function(xhr) {
            toastr.error('Failed to start scan');
        }
    });
}
</script>
{% endblock %}

{% block table_content %}
<table class="table w-full">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Timestamp</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for scan in scans %}
        <tr>
            <td>{{ scan.id }}</td>
            <td>{{ scan.name }}</td>
            <td>{{ scan.timestamp }}</td>
            <td>{{ scan.status }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}